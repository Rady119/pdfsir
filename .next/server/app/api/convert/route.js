"use strict";(()=>{var e={};e.id=183,e.ids=[183],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},10446:(e,o,t)=>{t.r(o),t.d(o,{headerHooks:()=>m,originalPathname:()=>h,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>u,staticGenerationBailout:()=>g});var r={};t.r(r),t.d(r,{OPTIONS:()=>OPTIONS,POST:()=>POST,dynamic:()=>i}),t(95655);var a=t(83323),n=t(54647),s=t(66886);let i="force-dynamic",l={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type","Cache-Control":"no-cache"};async function OPTIONS(){return new Response(null,{headers:l})}let delay=e=>new Promise(o=>setTimeout(o,e));async function POST(e){try{let o=process.env.CONVERTAPI_SECRET;if(!o)throw Error("CONVERTAPI_SECRET environment variable is not set");let t=await e.formData(),r=t.get("file"),a=t.get("format"),n="true"===t.get("isImageToPdf");if(!r)return s.Z.json({error:"No file provided"},{status:400,headers:l});if(n){if(!["image/jpeg","image/png"].includes(r.type))return s.Z.json({error:"Invalid file type. Please provide a JPEG or PNG image"},{status:400,headers:l})}else if("application/pdf"!==r.type)return s.Z.json({error:"Invalid file type. Please provide a PDF file"},{status:400,headers:l});if(r.size>10485760)return s.Z.json({error:"حجم الملف يتجاوز الحد الأقصى (10 ميجابايت)"},{status:413,headers:l});try{let e,t;console.log("Starting conversion...",{format:a,isImageToPdf:n,fileType:r.type,fileSize:r.size});let s=n?{pdf:"jpg/to/pdf,png/to/pdf"}:{docx:"pdf/to/docx,pdf/to/pdfdoc"};if(!a||!s[a])throw Error(`Format not supported: ${a}`);for(let i of["https://v1.convertapi.com","https://v2.convertapi.com","https://api.convertapi.com"]){let l=0,p="docx"===a?300:180,c=n?`${r.type.split("/")[1]}/to/pdf`:s[a],d=`${i}/convert/${c}?Secret=${o}&StoreFile=true&Timeout=${p}`;for(console.log("Conversion request:",{baseUrl:i,conversionPath:c,format:a,isImageToPdf:n,fileType:r.type,fileName:r.name});l<3;)try{console.log(`Trying ${i}, attempt ${l+1} of 3...`);let o=await r.arrayBuffer(),t=n?r.type:"application/pdf",s=new Blob([o],{type:t}),p=new FormData;p.append("File",s,r.name),p.append("StoreFile","true"),p.append("Timeout","180"),n||"docx"!==a||(p.append("OCR","true"),p.append("TextRecognition","true"),p.append("FromPage","1"),p.append("ToPage","0"));let c=new AbortController,u="docx"===a?3e5:18e4,f=setTimeout(()=>c.abort(),u),m=await fetch(d,{method:"POST",body:p,signal:c.signal}).finally(()=>clearTimeout(f));if(console.log("Response status:",m.status),415===m.status){let e=await m.text();throw console.error("415 Error details:",e),Error(`Unsupported Media Type: ${e}`)}if(!m.ok)throw Error(`HTTP error! status: ${m.status}`);if(e=await m.json()){console.log("Conversion request successful");break}}catch(e){if(t=e,"AbortError"===e.name){let e="docx"===a?"عملية تحويل PDF إلى Word استغرقت وقتاً طويلاً. يرجى المحاولة مع ملف أصغر حجماً":"عملية التحويل استغرقت وقتاً طويلاً. يرجى المحاولة مرة أخرى";throw console.error("Request timed out:","docx"===a?"5 minutes":"3 minutes"),Error(e)}console.error(`Attempt ${l+1} failed:`,e.message),await delay(1e3*Math.pow(2,l)),l++}if(e)break}if(!e)throw t||Error("All conversion attempts failed");if(console.log("Processing response..."),!e?.Files?.[0]?.Url)throw Error("لم يتم استلام رابط الملف المحول");console.log("Downloading converted file...");let i=new AbortController,p=setTimeout(()=>i.abort(),6e4),c=await fetch(e.Files[0].Url,{signal:i.signal}).finally(()=>clearTimeout(p));if(!c.ok)throw Error("Failed to download converted file");let d=n?"pdf":a,u=r.name.replace(/\.[^/.]+$/,""),f=encodeURIComponent(u);return new Response(c.body,{headers:{...l,"Content-Type":{docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",pdf:"application/pdf"}[d],"Content-Disposition":`attachment; filename="${f}.${d}"; filename*=UTF-8''${f}.${d}`,"Transfer-Encoding":"chunked","Cache-Control":"no-cache"}})}catch(o){console.error("Conversion error:",{message:o.message,status:o.status});let e="فشل التحويل";return o.message&&(e+=`: ${o.message}`),s.Z.json({error:e,details:{message:o.message,type:o.name,status:o.status}},{status:422,headers:l})}}catch(e){return console.error("Server error:",e),s.Z.json({error:"حدث خطأ غير متوقع. الرجاء المحاولة مرة أخرى",details:{message:e.message||"Unknown error",type:e.name||"ServerError",code:"INTERNAL_SERVER_ERROR"}},{status:500,headers:l})}}let p=a.AppRouteRouteModule,c=new p({definition:{kind:n.x.APP_ROUTE,page:"/api/convert/route",pathname:"/api/convert",filename:"route",bundlePath:"app/api/convert/route"},resolvedPagePath:"D:\\فلاشة16\\room\\pdf-processor\\src\\app\\api\\convert\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:d,staticGenerationAsyncStorage:u,serverHooks:f,headerHooks:m,staticGenerationBailout:g}=c,h="/api/convert/route"}};var o=require("../../../webpack-runtime.js");o.C(e);var __webpack_exec__=e=>o(o.s=e),t=o.X(0,[336,922],()=>__webpack_exec__(10446));module.exports=t})();